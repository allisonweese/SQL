Find top 10 countries by number of customers and top 10 cities 

-- Subquery to find top 10 countries
WITH TopCountries AS (
    SELECT 
        D.country,
        D.country_id
    FROM 
        customer A
    LEFT JOIN 
        address B ON A.address_id = B.address_id
    LEFT JOIN 
        city C ON B.city_id = C.city_id
    LEFT JOIN 
        country D ON C.country_id = D.country_id
    GROUP BY 
        D.country, D.country_id
    ORDER BY 
        COUNT(A.customer_id) DESC
    LIMIT 
        10
)
-- Main query to find top 10 cities in those top 10 countries
SELECT 
    C.city,
    D.country,
    COUNT(A.customer_id) AS customer_count
FROM 
    customer A
LEFT JOIN 
    address B ON A.address_id = B.address_id
LEFT JOIN 
    city C ON B.city_id = C.city_id

Find top 5 customers in top 5 cities

-- Subquery to find top 10 countries
WITH TopCountries AS (
    SELECT 
        D.country,
        D.country_id
    FROM 
        customer A
    LEFT JOIN 
        address B ON A.address_id = B.address_id
    LEFT JOIN 
        city C ON B.city_id = C.city_id
    LEFT JOIN 
        country D ON C.country_id = D.country_id
    GROUP BY 
        D.country, D.country_id
    ORDER BY 
        COUNT(A.customer_id) DESC
    LIMIT 
        10
),
-- Subquery to find top 10 cities in those top 10 countries
TopCities AS (
    SELECT 
        C.city,
        C.city_id,
        D.country,
        D.country_id
    FROM 
        customer A
    LEFT JOIN 
        address B ON A.address_id = B.address_id
    LEFT JOIN 
        city C ON B.city_id = C.city_id
    LEFT JOIN 
        country D ON C.country_id = D.country_id
    WHERE 
        D.country_id IN (SELECT country_id FROM TopCountries)
    GROUP BY 
        C.city, C.city_id, D.country, D.country_id
    ORDER BY 
        COUNT(A.customer_id) DESC
    LIMIT 
        10
)
-- Main query to find top 5 customers in those top 10 cities
SELECT 
    A.customer_id,
    A.first_name,
    A.last_name,
    D.country,
    C.city,
    SUM(E.amount) AS total_amount_paid
FROM 
    payment E
LEFT JOIN 
    customer A ON E.customer_id = A.customer_id
LEFT JOIN 
    address B ON A.address_id = B.address_id
LEFT JOIN 
    city C ON B.city_id = C.city_id
LEFT JOIN 
    country D ON C.country_id = D.country_id
WHERE 
    C.city_id IN (SELECT city_id FROM TopCities)
GROUP BY 
    A.customer_id, A.first_name, A.last_name, D.country, C.city
ORDER BY 
    total_amount_paid DESC
LIMIT 
    5;
