Query using CTE's

WITH TopCountries AS (
    SELECT 
        D.country,
        D.country_id
    FROM 
        customer A
    LEFT JOIN 
        address B ON A.address_id = B.address_id
    LEFT JOIN 
        city C ON B.city_id = C.city_id
    LEFT JOIN 
        country D ON C.country_id = D.country_id
    GROUP BY 
        D.country, D.country_id
    ORDER BY 
        COUNT(A.customer_id) DESC
    LIMIT 
        10
),
TopCities AS (
    SELECT 
        C.city,
        C.city_id,
        D.country,
        D.country_id
    FROM 
        customer A
    LEFT JOIN 
        address B ON A.address_id = B.address_id
    LEFT JOIN 
        city C ON B.city_id = C.city_id
    LEFT JOIN 
        country D ON C.country_id = D.country_id
    LEFT JOIN 
        TopCountries TC ON D.country_id = TC.country_id
    GROUP BY 
        C.city, C.city_id, D.country, D.country_id
    ORDER BY 
        COUNT(A.customer_id) DESC
    LIMIT 
        10
),
TopCustomers AS (
    SELECT 
        A.customer_id,
        A.first_name,
        A.last_name,
        D.country,
        C.city,
        SUM(E.amount) AS total_amount_paid
    FROM 
        payment E
    LEFT JOIN 
        customer A ON E.customer_id = A.customer_id
    LEFT JOIN 
        address B ON A.address_id = B.address_id
    LEFT JOIN 
        city C ON B.city_id = C.city_id
    LEFT JOIN 
        country D ON C.country_id = D.country_id
    LEFT JOIN 
        TopCities TC ON C.city_id = TC.city_id
    GROUP BY 
        A.customer_id, A.first_name, A.last_name, D.country, C.city
    ORDER BY 
        total_amount_paid DESC
    LIMIT 
        5
)
SELECT 
    AVG(total_amount_paid) AS average
FROM 
    TopCustomers;

Finding top 5 customers

WITH TopCountries AS (
    SELECT 
        D.country,
        D.country_id
    FROM 
        customer A
    LEFT JOIN 
        address B ON A.address_id = B.address_id
    LEFT JOIN 
        city C ON B.city_id = C.city_id
    LEFT JOIN 
        country D ON C.country_id = D.country_id
    GROUP BY 
        D.country, D.country_id
    ORDER BY 
        COUNT(A.customer_id) DESC
    LIMIT 
        10
),
TopCities AS (
    SELECT 
        C.city,
        C.city_id,
        D.country,
        D.country_id
    FROM 
        customer A
    LEFT JOIN 
        address B ON A.address_id = B.address_id
    LEFT JOIN 
        city C ON B.city_id = C.city_id
    LEFT JOIN 
        country D ON C.country_id = D.country_id
    LEFT JOIN 
        TopCountries TC ON D.country_id = TC.country_id
    GROUP BY 
        C.city, C.city_id, D.country, D.country_id
    ORDER BY 
        COUNT(A.customer_id) DESC
    LIMIT 
        10
),
Top5Customers AS (
    SELECT 
        A.customer_id,
        D.country,
        SUM(E.amount) AS total_amount_paid
    FROM 
        payment E
    LEFT JOIN 
        customer A ON E.customer_id = A.customer_id
    LEFT JOIN 
        address B ON A.address_id = B.address_id
    LEFT JOIN 
        city C ON B.city_id = C.city_id
    LEFT JOIN 
        country D ON C.country_id = D.country_id
    LEFT JOIN 
        TopCities TC ON C.city_id = TC.city_id
    GROUP BY 
        A.customer_id, D.country
    ORDER BY 
        total_amount_paid DESC
    LIMIT 
        5
),
CountryCustomerCounts AS (
    SELECT 
        country_table.country,
        COUNT(DISTINCT customer.customer_id) AS all_customer_count,
        COUNT(DISTINCT top_customers.customer_id) AS top_customer_count
    FROM 
        customer
    LEFT JOIN 
        address ON customer.address_id = address.address_id
    LEFT JOIN 
        city ON address.city_id = city.city_id
    LEFT JOIN 
        country AS country_table ON city.country_id = country_table.country_id
    LEFT JOIN (
        SELECT 
            customer_id,
            country
        FROM 
            Top5Customers
    ) AS top_customers ON country_table.country = top_customers.country
    GROUP BY 
        country_table.country
)
SELECT 
    country,
    all_customer_count,
    COALESCE(top_customer_count, 0) AS top_customer_count
FROM 
    CountryCustomerCounts;
